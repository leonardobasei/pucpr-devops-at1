name: Discord Alerts

on:
  push:
    branches: [ master, develop ]
  pull_request:
    types: [opened, closed, merged]
    branches: [ master ]

jobs:
  notify:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create notification message
      run: |
        # Determinar tipo de evento
        if [ "${{ github.event_name }}" = "push" ]; then
          if [ "${{ github.ref_name }}" = "master" ]; then
            EMOJI="ðŸ”¥"
            TITLE="ðŸš€ COMMIT NA MASTER (PRODUÃ‡ÃƒO)"
            COLOR="16711680"
            DESCRIPTION="Commit realizado na branch de produÃ§Ã£o"
          else
            EMOJI="ðŸ› ï¸"
            TITLE="ðŸš€ COMMIT NA DEVELOP (DESENVOLVIMENTO)"
            COLOR="16776960"
            DESCRIPTION="Commit realizado na branch de desenvolvimento"
          fi
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          if [ "${{ github.event.action }}" = "opened" ]; then
            EMOJI="ðŸ“"
            TITLE="ðŸ“ NOVA PULL REQUEST"
            COLOR="3447003"
            DESCRIPTION="Nova PR aberta para master"
          elif [ "${{ github.event.action }}" = "closed" ] && [ "${{ github.event.pull_request.merged }}" = "true" ]; then
            EMOJI="âœ…"
            TITLE="ðŸ”€ MERGE REALIZADO NA MASTER!"
            COLOR="65280"
            DESCRIPTION="Pull Request foi mergeada com sucesso"
          else
            EMOJI="âŒ"
            TITLE="âŒ PULL REQUEST FECHADA"
            COLOR="10038562"
            DESCRIPTION="Pull Request foi fechada sem merge"
          fi
        fi
        
        # Criar payload JSON
        cat > discord_payload.json << EOF
        {
          "username": "GitHub Actions",
          "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
          "embeds": [
            {
              "title": "${TITLE}",
              "description": "${EMOJI} ${DESCRIPTION}",
              "color": ${COLOR},
              "fields": [
                {
                  "name": "ðŸ“ RepositÃ³rio",
                  "value": "${{ github.repository }}",
                  "inline": true
                },
                {
                  "name": "ðŸŒ¿ Branch",
                  "value": "${{ github.ref_name }}",
                  "inline": true
                },
                {
                  "name": "ðŸ‘¤ Autor",
                  "value": "${{ github.actor }}",
                  "inline": true
                },
                {
                  "name": "ðŸ”— Commit",
                  "value": "[${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})",
                  "inline": false
                },
                {
                  "name": "ðŸ’¬ Mensagem",
                  "value": "${{ github.event.head_commit.message || github.event.pull_request.title || 'N/A' }}",
                  "inline": false
                }
              ],
              "footer": {
                "text": "GitHub Actions â€¢ $(date '+%Y-%m-%d %H:%M:%S UTC')",
                "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
              }
            }
          ]
        }
        EOF
        
        # Adicionar campo especÃ­fico para PRs
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          jq '.embeds[0].fields += [{"name": "ðŸ”— Pull Request", "value": "[#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})", "inline": false}]' discord_payload.json > temp.json && mv temp.json discord_payload.json
        fi
    
    - name: Send to Discord
      if: env.DISCORD_WEBHOOK_URL != ''
      run: |
        echo "ðŸ“¤ Enviando notificaÃ§Ã£o para o Discord..."
        curl -X POST \
             -H "Content-Type: application/json" \
             -d @discord_payload.json \
             ${{ secrets.DISCORD_WEBHOOK_URL }}
        echo "âœ… NotificaÃ§Ã£o enviada com sucesso!"
    
    - name: Debug (if webhook not configured)
      if: env.DISCORD_WEBHOOK_URL == ''
      run: |
        echo "âš ï¸ DISCORD_WEBHOOK_URL nÃ£o configurado!"
        echo ""
        echo "ðŸ“‹ Para configurar:"
        echo "1. Acesse seu servidor Discord"
        echo "2. VÃ¡ em ConfiguraÃ§Ãµes do Servidor > IntegraÃ§Ãµes > Webhooks"
        echo "3. Crie um novo webhook e copie a URL"
        echo "4. No GitHub: Settings > Secrets and variables > Actions"
        echo "5. Adicione secret 'DISCORD_WEBHOOK_URL' com a URL do webhook"
        echo ""
        echo "ðŸ“„ Payload que seria enviado:"
        cat discord_payload.json